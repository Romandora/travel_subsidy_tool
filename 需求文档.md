## 差旅补贴计算需求说明

### 1. 目的
基于 `utils/calculator.py` 逻辑，明确公司报销台账与客户结算台账匹配、补贴计算与输出要求，便于业务核对和后续开发。

### 2. 适用范围
- 公司报销文件（Excel）：包含员工差旅报销记录。
- 客户结算文件（Excel）：包含客户侧对员工的差旅包干结算记录。
- 输出：生成补贴明细的 `pandas.DataFrame`（可另行导出 Excel）。

### 3. 日均标准
- 派驻地日标准（元/天）：北京450、上海450、广州380、深圳380、其他区域330。
- 若派驻地未命中上述城市，默认使用“其他区域”标准。

### 4. 输入要求
#### 4.1 公司报销文件（必需列）
- `申请人`、`金额`、`出发日期`、`单据编号`
- 可选日期列：`第一目的地到达日期`、`第二目的地到达日期`、`第三目的地到达日期`（缺失时置为 None）

#### 4.2 客户结算文件（必需列）
- `候选人`、`常驻地`、`派驻地`、`结算入场时间`、`结算离场时间`、`差旅人天`、`派驻应用`、`差旅结算（含税）金额`
- 预处理：文本列去首尾空格；日期列转为日期；数值列转数值，非法转 NaN 后填 0。

### 5. 处理流程概述
1) **公司侧预处理**
   - 返程日期：在三个“到达日期”中取最晚的合法日期，若全缺则用 `出发日期`。
   - 公司差旅天数：`返程日期 - 出发日期 + 1`。
   - 汇总维度：`申请人 + 出发日期 + 返程日期`；金额求和，天数取首值，单据编号去重后逗号拼接。

2) **客户侧连续段合并**
   - 排序：`候选人`、`派驻应用`、`结算入场时间`、`结算离场时间`。
   - 合并规则：同一 `候选人` & `派驻应用` 且 **后一段入场时间 = 前一段离场时间 + 1 天**。合并时扩展离场时间，人天与结算金额累加。

3) **匹配条件**
   - 仅处理 `公司差旅天数 > 0` 的记录。
   - 客户记录需存在入/离场日期；若 `常驻地 == 派驻地` 则跳过（视为非外派，无补贴）。
   - 时间覆盖：公司出发/返程窗口需完全覆盖客户入/离场窗口（`comp_start <= cli_start` 且 `comp_end >= cli_end`）。

4) **补贴计算**
   - 客户包干总额：`client_total = rate * cli_days`（rate 来自派驻地表）。
   - 公司日均：`daily_rate_comp = comp_total / comp_days`。
   - 边界贴合判断：`start_diff = cli_start - comp_start`，`end_diff = comp_end - cli_end`，当二者均在 {0,1} 时视为“边界贴合”。
     - 边界贴合：`comp_amount_for_cli_days = comp_total`。
     - 否则：`comp_amount_for_cli_days = daily_rate_comp * cli_days`。
   - 补贴：`subsidy = max(0, client_total - comp_amount_for_cli_days)`，保留两位小数。

### 6. 输出字段
- `申请人`、`单据编号`、`常驻地`、`派驻地`、`派驻应用`
- `公司出发日期`、`公司返程日期`、`公司差旅天数`、`公司报销总金额`
- `客户结算入场时间`、`客户结算离场时间`、`客户差旅人天`
- `客户日均标准`、`客户包干总额`、`公司日均差旅费`、`公司标准下客户天数总额`
- `津贴金额`、`备注`
- 当 `津贴金额 = 0` 时，备注为：`Company reimbursement standard is greater than or equal to client standard, subsidy is 0`

### 7. 异常与校验
- 缺少必需列时抛出 `ValueError`，提示缺失列名。
- 若未生成任何补贴记录，抛出 `ValueError("No subsidy records were generated.")`。
- 日期/数值转换失败会被强制转为 NaN/0 后参与计算。

### 8. 使用示例
```python
from utils.calculator import process_files

df = process_files("公司报销.xlsx", "客户结算.xlsx")
df.to_excel("补贴明细.xlsx", index=False)
```
